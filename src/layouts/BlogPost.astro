---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import EmailCapture from '../components/EmailCapture.astro';
import AuthorBio from '../components/AuthorBio.astro';
import { formatDate } from '../utils/date';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  altText?: string;
  author?: string;
  tags?: string[];
}

const { title, description, pubDate, updatedDate, heroImage, altText, author = 'Andreas Duess', tags = [] } = Astro.props;

// Get related articles based on shared tags, with fallback to recent posts
const allPosts = await getCollection('blog');
const otherPosts = allPosts.filter(post => !post.data.draft && post.data.title !== title);

// First, get posts with shared tags
const postsWithSharedTags = otherPosts
  .map(post => {
    const sharedTags = post.data.tags?.filter(tag => tags.includes(tag)) || [];
    return { post, sharedTagCount: sharedTags.length };
  })
  .filter(item => item.sharedTagCount > 0)
  .sort((a, b) => b.sharedTagCount - a.sharedTagCount);

// Get up to 2 posts with shared tags
let relatedPosts = postsWithSharedTags.slice(0, 2).map(item => item.post);

// If we don't have 2 posts yet, fill with recent posts
if (relatedPosts.length < 2) {
  const usedSlugs = new Set(relatedPosts.map(p => p.slug));
  const recentPosts = otherPosts
    .filter(post => !usedSlugs.has(post.slug))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 2 - relatedPosts.length);
  relatedPosts = [...relatedPosts, ...recentPosts];
}
---

<BaseLayout
  title={title}
  description={description}
  image={heroImage}
  article={true}
  pubDate={pubDate}
  updatedDate={updatedDate}
>
  <!-- Structured Data - Article Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": title,
    "description": description,
    "image": heroImage ? new URL(heroImage, Astro.site).toString() : undefined,
    "datePublished": pubDate.toISOString(),
    "dateModified": updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
    "author": {
      "@type": "Person",
      "name": author,
      "url": "https://tenuredadvantage.com/about"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Tenured Advantage",
      "logo": {
        "@type": "ImageObject",
        "url": "https://tenuredadvantage.com/Andreas-Headshot.jpg"
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": new URL(Astro.url.pathname, Astro.site).toString()
    },
    "keywords": tags?.join(", ")
  })} />

  <!-- Structured Data - BreadcrumbList Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://tenuredadvantage.com/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Blog",
        "item": "https://tenuredadvantage.com/blog"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": title,
        "item": new URL(Astro.url.pathname, Astro.site).toString()
      }
    ]
  })} />

  <Header />

  <main class="article-container">
    <article class="blog-post">
      {heroImage && (
        <img src={heroImage} alt={altText || title} class="hero-image" />
      )}

      <header class="article-header">
        <h1>{title}</h1>
        <div class="article-meta">
          <time datetime={pubDate.toISOString()}>
            {formatDate(pubDate)}
          </time>
          {updatedDate && (
            <span class="updated">
              (Updated: {formatDate(updatedDate)})
            </span>
          )}
          <span class="author">by {author}</span>
        </div>
        {tags.length > 0 && (
          <div class="tags">
            {tags.map(tag => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )}
      </header>

      <!-- Email Capture - Top of Article -->
      <EmailCapture />

      <div class="article-content">
        <slot />
      </div>

      <!-- Email Capture - Bottom of Article -->
      <div class="bottom-cta">
        <EmailCapture
          headline="Get AI Insights for Experienced Professionals"
          description="Join other professionals leveraging decades of experience with AI. Practical insights, no hype."
        />
      </div>

      <!-- Author Bio -->
      <AuthorBio author={author} />

      {relatedPosts.length > 0 && (
        <div class="related-articles">
          <h2>Related Articles</h2>
          <div class="related-grid">
            {relatedPosts.map(post => (
              <a href={`/blog/${post.slug}/`} class="related-card">
                {post.data.heroImage && (
                  <img src={post.data.heroImage} alt={post.data.title} class="related-image" />
                )}
                <div class="related-content">
                  <h3>{post.data.title}</h3>
                  <p>{post.data.description}</p>
                  <span class="read-more">Read article â†’</span>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}
    </article>

    <aside class="sidebar">
      <div class="sidebar-widget">
        <h3>About Andreas</h3>
        <p>
          Andreas Duess helps experienced professionals leverage AI to amplify their competitive advantage.
          With 30+ years bridging tech and traditional industries, he's the CEO of 6 Seeds and teaches AI strategy at Ivey Business School.
        </p>
      </div>

      <div class="sidebar-widget">
        <h3>Popular Topics</h3>
        <ul>
          <li><a href="/blog/tag/ai-strategy">AI Strategy</a></li>
          <li><a href="/blog/tag/career-longevity">Career Longevity</a></li>
          <li><a href="/blog/tag/experience-advantage">Experience Advantage</a></li>
        </ul>
      </div>
    </aside>
  </main>

  <Footer />
</BaseLayout>

<style>
  .article-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 3rem 2rem;
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 3rem;
  }

  .blog-post {
    max-width: 65ch;
  }

  .hero-image {
    width: 100%;
    height: auto;
    border-radius: 12px;
    margin-bottom: 2rem;
  }

  .article-header {
    margin-bottom: 3rem;
  }

  .article-header h1 {
    margin-top: 0;
    font-size: 2.5rem;
    line-height: 1.2;
  }

  .article-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
    color: #6b7280;
    font-size: 0.9rem;
    margin-top: 1rem;
  }

  .updated {
    color: #9ca3af;
    font-style: italic;
  }

  .tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  .tag {
    background: #f3f4f6;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.85rem;
    color: #4b5563;
  }

  .article-content {
    font-size: 1.1rem;
    line-height: 1.8;
  }

  .article-content :global(pre) {
    overflow-x: auto;
    background: #1e293b;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1.5rem 0;
    max-width: 100%;
  }

  .article-content :global(code) {
    font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
    font-size: 0.9em;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .article-content :global(pre code) {
    white-space: pre;
    word-wrap: normal;
  }

  .article-content :global(h2) {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .bottom-cta {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 2px solid #e5e7eb;
  }

  .related-articles {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 2px solid #e5e7eb;
  }

  .related-articles h2 {
    font-size: 1.75rem;
    margin-bottom: 2rem;
    margin-top: 0;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
  }

  .related-card {
    display: block;
    background: #f9fafb;
    border-radius: 12px;
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .related-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }

  .related-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }

  .related-content {
    padding: 1.5rem;
  }

  .related-content h3 {
    margin-top: 0;
    font-size: 1.1rem;
    line-height: 1.3;
    margin-bottom: 0.75rem;
  }

  .related-content p {
    font-size: 0.9rem;
    color: #6b7280;
    line-height: 1.5;
    margin-bottom: 1rem;
  }

  .read-more {
    color: #3e4956;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .sidebar {
    position: sticky;
    top: 6rem;
    height: fit-content;
  }

  .sidebar-widget {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
  }

  .sidebar-widget h3 {
    margin-top: 0;
    font-size: 1.1rem;
  }

  .sidebar-widget p {
    font-size: 0.9rem;
    color: #4b5563;
    margin-bottom: 0;
  }

  .sidebar-widget ul {
    list-style: none;
    padding: 0;
  }

  .sidebar-widget li {
    margin-bottom: 0.5rem;
  }

  .sidebar-widget a {
    color: #3e4956;
    text-decoration: none;
    font-size: 0.95rem;
  }

  @media (max-width: 1024px) {
    .article-container {
      grid-template-columns: 1fr;
    }

    .sidebar {
      position: static;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
  }

  @media (max-width: 768px) {
    .article-container {
      padding: 2rem 1rem;
    }

    .article-header h1 {
      font-size: 2rem;
    }

    .sidebar {
      grid-template-columns: 1fr;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
